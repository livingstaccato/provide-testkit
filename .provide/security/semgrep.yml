# Semgrep Configuration for provide-testkit
# https://semgrep.dev/docs/writing-rules/overview/

# This file can contain:
# 1. Configuration for semgrep CLI behavior
# 2. Custom rules for project-specific patterns

# Use official rule registries
# These are passed via --config flag
# Common registries:
# - p/python               # Python security rules
# - p/security-audit      # General security audit
# - p/owasp-top-ten       # OWASP Top 10
# - p/secrets             # Secret detection
# - auto                  # Auto-detect language and apply rules

rules:
  # Example: Prevent use of eval() in production code
  - id: no-eval
    pattern: eval(...)
    message: "eval() is dangerous and should not be used in production code"
    languages: [python]
    severity: ERROR
    metadata:
      category: security
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      subcategory:
        - audit
      technology:
        - python

  # Example: Ensure passwords are not hardcoded
  - id: hardcoded-password-assignment
    patterns:
      - pattern: $VAR = "..."
      - metavariable-regex:
          metavariable: $VAR
          regex: (?i)(password|passwd|pwd|secret|token|api_key)
    message: "Potential hardcoded password/secret assignment"
    languages: [python]
    severity: WARNING
    metadata:
      category: security
      confidence: MEDIUM
    paths:
      exclude:
        - "**/test_*.py"
        - "**/*_test.py"
        - "**/fixtures.py"
        - "**/conftest.py"

  # Example: Ensure subprocess calls use shell=False
  - id: subprocess-shell-true
    pattern: subprocess.$FUNC(..., shell=True, ...)
    message: "subprocess with shell=True can be vulnerable to shell injection"
    languages: [python]
    severity: WARNING
    fix: |
      Consider using shell=False and passing command as a list

  # Example: Detect SQL injection patterns
  - id: sql-injection-format-string
    patterns:
      - pattern-either:
          - pattern: $CURSOR.execute(f"...", ...)
          - pattern: $CURSOR.execute("..." % ..., ...)
          - pattern: $CURSOR.execute("..." + ..., ...)
    message: "Potential SQL injection - use parameterized queries instead"
    languages: [python]
    severity: ERROR

  # Example: Ensure cryptographic operations use secure defaults
  - id: insecure-hash-algorithm
    pattern-either:
      - pattern: hashlib.md5(...)
      - pattern: hashlib.sha1(...)
    message: "MD5 and SHA1 are considered insecure for cryptographic purposes"
    languages: [python]
    severity: WARNING
    paths:
      exclude:
        - "**/test_*.py"

# Global path exclusions (applies to all rules)
# These are enforced via CLI --exclude flags
paths:
  exclude:
    - "**/test_*.py"
    - "**/*_test.py"
    - "**/tests/**"
    - "**/.venv/**"
    - "**/venv/**"
    - "**/__pycache__/**"
    - "**/site-packages/**"
    - "**/.security/**"
    - "**/build/**"
    - "**/dist/**"
